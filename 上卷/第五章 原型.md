# ç¬¬äº”ç«  åŸå‹

<!-- TOC -->

- [ç¬¬äº”ç«  åŸå‹](#ç¬¬äº”ç« -åŸå‹)
  - [[[Prototype]]](#prototype)
    - [[[PUT]] å’Œå±è”½å±æ€§](#put-å’Œå±è”½å±æ€§)
      - [è®¿é—®ä¼˜å…ˆçº§](#è®¿é—®ä¼˜å…ˆçº§)
      - [è§£æ [[PUT]]](#è§£æ-put)
    - [éšå¼å±è”½](#éšå¼å±è”½)
  - [ç±»](#ç±»)
    - [æ„é€ å‡½æ•°](#æ„é€ å‡½æ•°)
    - [constructor çš„è¯¯åŒº](#constructor-çš„è¯¯åŒº)
  - [åŸå‹ç»§æ‰¿](#åŸå‹ç»§æ‰¿)

<!-- /TOC -->

## [[Prototype]]

`JavaScript` ä¸­æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ `[[Prototype]]` å†…ç½®å±æ€§, é€šè¿‡è¯¥å¯¹è±¡çš„ `__proto__` å±æ€§å¯ä»¥è§‚æµ‹åˆ°å®ƒä»¬,

ä»¥ä¸‹ç¤ºä¾‹, æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„å­—ç¬¦ä¸²çš„æ–¹æ³•, å®ƒä»¬éƒ½å­˜æ”¾åœ¨å†…ç½®å¯¹è±¡ `String` çš„ `[[Prototype]]` å±æ€§ä¸­:

``` javascript
var str = new String('str')

// console
> str
< String: {
  0: "s",
  1: "t",
  2: "r",
  length: 3,
  __proto__: {
    toUpperCase: function toUpperCase(),
    concat: function concat(),
    charAt: function charAt(),
    ...
  }
}
```

> è¯·æ€è€ƒ, ä¸ºä»€ä¹ˆ `str.toUpperCase()` èƒ½å¤Ÿè®¿é—®åˆ° `toUpperCase` å‡½æ•°æ–¹æ³•?

åœ¨ [ç¬¬ä¸‰ç«  å¯¹è±¡](https://github.com/muzqi/you-dont-know-js/blob/master/%E4%B8%8A%E5%8D%B7/%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E5%AF%B9%E8%B1%A1.md#get-put) ä¸­æˆ‘ä»¬è®¨è®ºè¿‡å¯¹è±¡é»˜è®¤çš„ `[[GET]]` æ“ä½œ:
- è¯¥æ“ä½œç¬¬ä¸€æ­¥ä¼šæ£€æŸ¥å¯¹è±¡æœ¬èº«æ˜¯å¦æœ‰è¿™ä¸ªå±æ€§, å¦‚æœæœ‰å°±ä½¿ç”¨å®ƒ
- å¦‚æœæ²¡æœ‰, å°±ä¼šåœ¨è¯¥å¯¹è±¡çš„ `[[Prototype]]` å±æ€§ä¸­æŸ¥æ‰¾, ç›´åˆ°æ‰¾åˆ°å±æ€§æˆ–æŸ¥æ‰¾å®Œæ•´æ¡åŸå‹é“¾
- å¦‚æœæœ€ç»ˆæ²¡æœ‰æ‰¾åˆ°, å°±ä¼šæŠ›å‡º `undefined`

> è¿˜è®°å¾—æˆ‘ä»¬è®¨è®ºçš„ å¦‚ä½•åˆ¤æ–­æŸä¸ªå¯¹è±¡ä¸­æ˜¯å¦æœ‰æŸä¸€å±æ€§çš„æ–¹æ³•ä¹ˆ?

é€šå¸¸æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼åˆ¤æ–­:
- obj.**hasOwnProperty**(property = `String`) è¯¥æ–¹æ³•åªä¼šæŸ¥æ‰¾å¯¹è±¡çš„**è‡ªèº«å±æ€§**
- `key` in **obj** è¯¥æ–¹æ³•ä¸ `[[GET]]` ç±»ä¼¼, è‡ªèº«å±æ€§æ‰¾ä¸åˆ°å°±ä¼šåˆ° `[[Prototype]]` ä¸­æ‰¾, ç›´åˆ°æ‰¾åˆ°æˆ–æ‰¾å®Œæ•´æ¡åŸå‹é“¾ä¸ºæ­¢

ç”±æ­¤, æˆ‘ä»¬å¯ä»¥åˆ¤æ–­, `for...in` å¾ªç¯æ˜¯å¯ä»¥æšä¸¾å‡ºå¯¹è±¡åŸå‹é“¾ä¸­çš„å±æ€§çš„:

``` javascript
var prototype = {
    name: 'muzi',
    age: 25
}
prototype.__proto__.loc = 'cq'

var person = Object.create(prototype)

for (var key in person) {
    console.log(key) // name age loc
}
```

> Object.create(prototype = `Object`) è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°, è¿”å›ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡, æ–°å¯¹è±¡ä¼šå°†å‚æ•°ä¸­çš„å¯¹è±¡ä½œä¸ºè‡ªå·±çš„ `[[Prototype]]` å±æ€§.

### [[PUT]] å’Œå±è”½å±æ€§

#### è®¿é—®ä¼˜å…ˆçº§

è¯´åˆ°å±è”½å±æ€§, æˆ‘ä»¬å°±å¿…é¡»å¼„æ¸…æ¥šå¯¹è±¡å±æ€§è®¿é—®çš„ä¼˜å…ˆçº§

- å¯¹è±¡**è‡ªèº«å±æ€§**çš„ä¼˜å…ˆçº§æœ€é«˜, å¦‚ä¸‹æ‰€ç¤º, å¯¹è±¡è‡ªèº«çš„ `name` ä¼š *å±è”½* åŸå‹ä¸Šæ‰€æœ‰çš„ `name`:

``` javascript
var obj = {
  name: 'muzi'
}

obj.__proto__.name = 'yaya'

console.log(obj.name) // muzi
```

- å¯¹äºåŸå‹é“¾æ¥è¯´, è¶Šä¸Šå±‚, ä¼˜å…ˆçº§è¶Šé«˜, å¦‚ä¸‹æ‰€ç¤º, æœ€ä¸Šå±‚åŸå‹ä¸­çš„ `name` å±è”½äº†ä¸‹å±‚çš„ `name`

``` javascript
var prototype = {}
prototype.__proto__.name = 'yaya'

var obj = Object.create(prototype)
obj.age = 25
obj.__proto__.name = 'muzi'

// console
> obj
< {
  age: 25,
  __proto__: {
    name: "muzi",
    __proto__: {
      name: "yaya"
    }
  }
}

> obj.name
< "muzi"
```

æˆ‘ä»¬å°†è¿™ç§å±è”½äº†å…¶ä»–å±æ€§çš„å±æ€§, ç§°ä¹‹ä¸º **å±è”½å±æ€§**

#### è§£æ [[PUT]]
å¯¹è±¡é»˜è®¤çš„ `[[PUT]]` æ“ä½œä¼šåœ¨å±æ€§èµ‹å€¼çš„æƒ…å†µä¸‹è§¦å‘, å®ƒæ¯” `[[GET]]` æ“ä½œè¦å¤æ‚è®¸å¤š, æˆ‘ä»¬å…¨æ–¹ä½çš„æ¥è§£æä»¥ä¸‹è¯­å¥, ç†è§£ `[[PUT]]` çš„å·¥ä½œæ¨¡å¼:

``` javascript
obj.name = 'muzi'
```

> ä»¥ä¸‹ä¸‰å¤§è§„åˆ™, å°†åœ¨åç»­ä»¥ `1)` ç­‰åºå·çš„æ–¹å¼å¼•ç”¨:

- 1)å¦‚æœ `name` æ˜¯å¯¹è±¡çš„**è‡ªèº«å±æ€§**, è¯¥èµ‹å€¼è¯­å¥åªä¼šä¿®æ”¹å¯¹è±¡è‡ªèº«å·²æœ‰ `name`

- 2)å¦‚æœ `name` ä¸æ˜¯å¯¹è±¡çš„**è‡ªèº«å±æ€§**, ä¹Ÿä¸åœ¨ `[[Prototype]]` é“¾ä¸­, `name` å°±ä¼šç›´æ¥æ·»åŠ åˆ°å¯¹è±¡çš„è‡ªèº«å±æ€§ä¸Š

- 3)å¦‚æœ `name` ä¸æ˜¯å¯¹è±¡çš„**è‡ªèº«å±æ€§**, è€Œåœ¨ `[[Prototype]]` é“¾ä¸­, ä¼šå‡ºç°ä»¥ä¸‹ä¸‰ç§æƒ…å†µ:
  - 3.1)å¦‚æœ `name` å¯å†™ *(writable: true)*, ç›´æ¥åœ¨ä¸ºå¯¹è±¡åˆ›å»ºä¸€ä¸ªåŒåçš„**è‡ªèº«å±æ€§**, å¹¶èµ‹å€¼, è¿™æ˜¯ä¸€ä¸ª**å±è”½å±æ€§**, è¯¥å±æ€§**å±è”½**äº†åŸå‹é“¾ä¸Šæ‰€æœ‰åŒåå±æ€§

  - 3.2)å¦‚æœ `name` åªè¯» *(writable: false)*, è¯¥èµ‹å€¼è¯­å¥ä¼šè¢«å¿½ç•¥. å¦‚æœè¿è¡Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹, ä¼šæŠ›å‡º `TypeError` çš„é”™è¯¯.

  - 3.3)å¦‚æœ `name` æ˜¯ä¸€ä¸ª `setter` ([å‚è§ç¬¬ä¸‰ç« ](https://github.com/muzqi/you-dont-know-js/blob/master/%E4%B8%8A%E5%8D%B7/%E7%AC%AC%E4%B8%89%E7%AB%A0%20%E5%AF%B9%E8%B1%A1.md#getter-setter)), é‚£å°±ä¸€å®šä¼šè°ƒç”¨è¿™ä¸ª `setter`, ä¸ä¼šåˆ›å»ºä¸€ä¸ª**å±è”½å±æ€§**, ä¹Ÿä¸ä¼šé‡æ–°å®šä¹‰ `name` çš„ `setter`.

äº‹å®ä¸Š, åœ¨ è§„åˆ™`3)` ä¸­, åªæœ‰ è§„åˆ™`3.1)` ä¼šåˆ›å»º **å±è”½å±æ€§**;

å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨ è§„åˆ™`3.2)` å’Œ è§„åˆ™`3.3)` åˆ›å»ºå±è”½å±æ€§ `name`, æˆ‘ä»¬éœ€è¦ä½¿ç”¨ `Object.defineProperty()`:

``` javascript
// è§„åˆ™ 3.2)
var prototype = {}
Object.defineProperty(prototype, 'name', {
    value: 'yaya',
    writable: false,  // åªè¯»
})

var obj = Object.create(prototype)

Object.defineProperty(obj, 'name', {
    value: 'muzi'
})

// console
> obj
< {
  name: "muzi",
  __proto__: {
    name: "yaya"
  }
}
```


``` javascript
// è§„åˆ™ 3.3)
var prototype = {}
Object.defineProperty(prototype, 'name', {
    get() {
      // è¿™é‡Œçš„ this å³æŒ‡å‘äº† obj å¯¹è±¡
      return this._name_ || 'yaya'
    },
    set(newVal) {
        this._name_ = newVal
    }
})

var obj = Object.create(prototype)

// console
> obj
< {
  name: "yaya",
  __proto__: {
    name: "yaya"
  }
}

> obj.name = "muzi"
< "muzi"

> obj
< {
  _name_: "muzi",
  name: "muzi",
  __proto__: {
    name: "muzi"
  }
}
```

### éšå¼å±è”½

> éšå¼å±è”½, å³éšå¼çš„åˆ›å»ºäº† **å±è”½å±æ€§**; è¿™å¹¶ä¸æ˜¯ä»€ä¹ˆç‰¹æ®Šçš„è¯­æ³•é€ æˆçš„, åªè¦ä½ ç†Ÿæ‚‰è¯­è¨€çš„ç‰¹æ€§, å°±èƒ½çœ‹å‡ºå…¶ä¸­çš„ç«¯å€ª, å¦‚ä¸‹æ‰€ç¤º:

``` javascript
var prototype = {
    count: 1
}

var obj = Object.create(prototype)

// console
> obj
< {
  __proto__: {
    count: 1,
  }
}
```

æˆ‘ä»¬æƒ³ä½¿å¯¹è±¡åŸå‹ä¸­çš„ `count` å±æ€§åŠ ä¸€:

``` javascript
// console
> obj.count++
< 1

> obj
< {
  count: 2,
  __proto__: {
    count: 1,
  }
}
```

å¯¹è±¡ä¸ºè‡ªå·±æ·»åŠ äº†ä¸€ä¸ªè¿ç®—åçš„è‡ªèº«å±æ€§ `count`, åŸå‹é“¾ä¸­çš„ `count` è¢«å±è”½äº†!

> è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœ, å› ä¸ºæˆ‘ä»¬åªæƒ³æ”¹å˜åŸå‹é“¾ä¸­çš„ `count`, ä½†ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢?

- `obj.count++` å®é™…ä¸Šæ˜¯ `obj.count = obj.count + 1` çš„ç¼©å†™
- ç”±æ­¤çœ‹å‡º, `count` è¢« ([[PUT]]) èµ‹å€¼äº†
- å¯¹è±¡è‡ªèº«å±æ€§ä¸­æ²¡æœ‰ `count`, ä½†åœ¨åŸå‹é“¾ä¸­æœ‰, æ‰€ä»¥è¿ç”¨äº†è§„åˆ™ `3.1)`, ä¸ºå¯¹è±¡åˆ›å»ºä¸€ä¸ªåŒåçš„è‡ªèº«å±æ€§, å±è”½æ‰€æœ‰åŒååŸå‹é“¾ä¸­çš„å±æ€§

> é‚£ä¹ˆå¦‚ä½•æ—¢æ”¹å˜åŸå‹é“¾å±æ€§, åˆä¸è§¦å‘ `éšå¼å±è”½` å‘¢?

å¯¹è±¡çš„åŸå‹å¯¹è±¡åªæ˜¯ `prototype` çš„å¼•ç”¨, æ‰€ä»¥æ”¹å˜**æº**å¯¹è±¡å³å¯:

``` javascript
// console:
> prototype.count++
< 1
> obj
< {
  __proto__: {
    count: 2
  },
}
```

## ç±»

> ç±»æ˜¯ä»€ä¹ˆ?

åœ¨é¢å‘ç±»çš„è¯­è¨€ä¸­, ç±»æ˜¯å¯ä»¥è¢«å¤åˆ¶(å®ä¾‹åŒ–)å¤šæ¬¡çš„, å°±åƒæ¨¡å…·åˆ¶ä½œä¸œè¥¿ä¸€æ ·.

### æ„é€ å‡½æ•°

> å¯¹äº JavaScript æ¥è¯´, ç±»æ˜¯ä»€ä¹ˆ?

ä¸€ç›´ä»¥æ¥ `JavaScript` åªæ˜¯æœ‰"ç±»ä¼¼ç±»"çš„è¡Œä¸º, ä½†å®é™…ä¸Šå¹¶æ²¡æœ‰**ç±»**, å®ƒåªæœ‰**å¯¹è±¡**, è¿™ç§è¡Œä¸ºåˆ©ç”¨äº†å‡½æ•°çš„ä¸€ç§ç‰¹æ®Šç‰¹æ€§:

æ‰€æœ‰å‡½æ•°é»˜è®¤éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªåä¸º `prototype` çš„å…¬æœ‰å¹¶ä¸å¯æšä¸¾çš„å±æ€§, `new` æ“ä½œç¬¦å°†è¿™ä¸ªå¯¹è±¡å…³è”åˆ°å…¶è¿”å›çš„æ–°å¯¹è±¡çš„åŸå‹ä¸Š

``` javascript
function Foo() {}
Foo.prototype.name = 'muzi'

// console
> Foo.prototype
< {
  name: "muzi",
  constructor: {...},
  __proto__: {
    constructor: {...},
    hasOwnProperty: hasOwnProperty(),
    isPrototypeOf: isPrototypeOf()
  }
}
```

æˆ‘ä»¬å°è¯•å°† `Foo` æ„é€ å‡½æ•°å®ä¾‹åŒ–(ä½¿ç”¨ `new` æ“ä½œç¬¦è°ƒç”¨):

``` javascript
var foo = new Foo()

// console
> foo
< Foo {
  __proto__: {
    name: "muzi",
    constructor: Foo(),
    __proto__: {...}
  }
}
```

æ²¡é”™, `new` æ“ä½œç¬¦åªæ˜¯å°† `Foo` æ„é€ å‡½æ•°çš„ `prototype` å…³è”åˆ°äº†æ–°çš„ `foo` å¯¹è±¡çš„åŸå‹ä¸Š, ä»…ä»…æ˜¯å¼•ç”¨, æ²¡æœ‰è¿›è¡Œå¤åˆ¶,

``` javascript
// console

// æˆ‘ä»¬æ”¹å˜æºå¯¹è±¡ä¸­çš„å±æ€§ name, å‘ç°å®ä¾‹å¯¹è±¡ foo çš„ name ä¹Ÿæ”¹å˜äº†
> Foo.prototype.name = 'yaya'
< "yaya"
> foo.name
< "yaya"
```

**æ„é€ å‡½æ•°**å¹¶æ²¡æœ‰çœŸæ­£æ„é€ ä»€ä¹ˆ, å®ƒåªæ˜¯è¢« `new` è°ƒç”¨çš„æ™®é€šå‡½æ•°è€Œå·²

### constructor çš„è¯¯åŒº

å½“ä½¿ç”¨**æ„é€ å‡½æ•°**åˆ›å»ºä¸€ä¸ªå®ä¾‹å, å®ä¾‹ä¸­ä¼šå­˜åœ¨ä¸€ä¸ª `constructor` å±æ€§:
``` javascript
function Foo() {}
var foo = new Foo()

// console
> foo.constructor === Foo
< true
```

> `constructor` å³æ„é€ å™¨çš„æ„æ€, *å®ä¾‹çš„æ„é€ å™¨*ä¸*æ„é€ å‡½æ•°*æ’ç­‰, æ€ä¹ˆèƒ½è¯´å®ä¾‹ä¸æ˜¯ç”±æ„é€ å‡½æ•°**æ„é€ **çš„å‘¢?

çœ‹ä»¥ä¸‹ä»£ç :

``` javascript
function Foo() {}
Foo.prototype = {
    name: 'Foo'
}

var foo = new Foo()

// console
> foo.constructor === Foo
< false
> foo.constructor === Object
< true
```

ä» `foo.constructor === Foo` ä¸º `false` å¯ä»¥çœ‹å‡º, å¦‚æœæˆ‘ä»¬å°†å®ä¾‹çš„ `constructor` ç†è§£ä¸ºè¯¥å®ä¾‹ç”±è°æ„é€ çš„è¯, ç»å¯¹æ˜¯é”™è¯¯çš„:

- `Foo` æ„é€ å‡½æ•°çš„ `prototype` è¢«å®Œå…¨é‡å†™äº†, å–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡

- æˆ‘ä»¬è¯´è¿‡, `var foo = new Foo()` ä»…ä»…æ˜¯å°† `Foo.prototype` å…³è”åˆ°äº† `foo` å¯¹è±¡çš„åŸå‹ä¸Š, æ­¤æ—¶çš„ `Foo.prototype` å¯¹è±¡ä¸­æ ¹æœ¬å°±æ²¡æœ‰ `constructor`

- æ—¢ç„¶æ²¡æœ‰ `foo` å¯¹è±¡ç»§æ‰¿è¿‡æ¥çš„åŸå‹ä¸Šæ²¡æœ‰ `constructor`, æ ¹æ® `[[GET]]` çš„è¡Œä¸ºå‡†åˆ™, `foo.constructor` ä¼šåœ¨åŸå‹é“¾ä¸­ä¸€å±‚ä¸€å±‚çš„æ‰¾è¯¥å±æ€§, æ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ°äº†é“¾é¡¶ç«¯çš„ `Object.prototype.constructor`, è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ `foo.constructor === Object` çš„åŸå› 

å¾ˆé—æ†¾, åœ¨æ²¡æœ‰æ”¹å†™ `Foo.prototype` ä¹‹å‰,

`foo.constructor === Foo` ä»…ä»…æ˜¯ä¸ªå·§åˆ, æ°å·§åœ¨ `new` æ“ä½œç¬¦å…³è”ä¸¤ä¸ªå¯¹è±¡çš„æ—¶å€™, æŠŠ `Foo` æ„é€ å‡½æ•°çš„ `constructor` ç»™äº† `foo` å®ä¾‹

> å½“ç„¶, æˆ‘ä»¬å¯ä»¥è‡ªå·±åŠ¨æ‰‹ä¸º **æ„é€ å‡½æ•°** æ·»åŠ  `constructor` å±æ€§, æ¥æ¬ºéª—è‡ªå·±-æ„é€ å‡½æ•°ç¡®å®æ˜¯æ„é€ äº†å®ä¾‹ğŸ˜­

``` javascript
function Foo() {}
Object.defineProperty(Foo.prototype, 'constructor', {
    enumerable: false,  // ä¸å¯æšä¸¾
    writable: true,
    configurable: true,
    value: Foo
})

var foo = new Foo()

// console
> foo.constructor === Foo
< true
```

æ€»ç»“:

å®ä¾‹çš„ `constructor` ä»…ä»…æ˜¯ä¸ªä¸å¯æšä¸¾çš„æ™®é€šå±æ€§(ç”šè‡³å¯ä»¥è¢«ç¯¡æ”¹), å®ƒä»¬ä¸ä¸€å®šä¼šæŒ‡å‘çœŸæ­£çš„**å‡½æ•°å¼•ç”¨**, æ‰€ä»¥å®é™…å¼€å‘è¿‡ç¨‹ä¸­è¦é¿å…ä½¿ç”¨å®ƒä»¬.

## åŸå‹ç»§æ‰¿
